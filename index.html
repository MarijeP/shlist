<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>shlist</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #f9f7f4;
    --surface: #ffffff;
    --border: #e8e4de;
    --text: #1a1814;
    --muted: #9b9589;
    --accent: #2d6a4f;
    --checked-text: #b0aa9f;
    --danger: #c0392b;
  }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
  #login-screen {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }

  .login-card {
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: 18px;
    padding: 48px 40px 40px;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 4px 40px rgba(0,0,0,0.06);
  }

  .login-card h1 {
    font-family: 'DM Serif Display', serif;
    font-size: 2rem;
    font-weight: 400;
    letter-spacing: -0.5px;
    margin-bottom: 4px;
  }

  .login-card h1 em { font-style: italic; color: var(--accent); }

  .login-subtitle {
    color: var(--muted);
    font-size: 0.85rem;
    font-weight: 300;
    margin-bottom: 32px;
  }

  .field { margin-bottom: 14px; }

  .field label {
    display: block;
    font-size: 0.78rem;
    font-weight: 500;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 6px;
  }

  .field input {
    width: 100%;
    padding: 12px 14px;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.95rem;
    background: var(--bg);
    color: var(--text);
    outline: none;
    transition: border-color 0.2s;
  }

  .field input:focus { border-color: var(--accent); background: white; }

  .btn-primary {
    width: 100%;
    padding: 13px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 10px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    margin-top: 8px;
    transition: opacity 0.2s, transform 0.1s;
  }

  .btn-primary:hover { opacity: 0.88; }
  .btn-primary:active { transform: scale(0.98); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

  .login-error {
    background: #fdf0ee;
    border: 1.5px solid #f5c0b8;
    border-radius: 8px;
    padding: 10px 14px;
    font-size: 0.85rem;
    color: var(--danger);
    margin-top: 14px;
    display: none;
  }

  /* ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ */
  #app-screen { display: none; min-height: 100vh; flex-direction: column; }

  .tab-bar {
    background: var(--surface);
    border-bottom: 1.5px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 20px;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .tab-bar-title {
    font-family: 'DM Serif Display', serif;
    font-size: 1.1rem;
    font-style: italic;
    color: var(--accent);
    margin-right: 20px;
    padding: 16px 0;
    white-space: nowrap;
  }

  .tabs { display: flex; gap: 4px; flex: 1; }

  .tab {
    padding: 12px 16px;
    border: none;
    background: none;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.88rem;
    font-weight: 400;
    color: var(--muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -1.5px;
    transition: color 0.2s, border-color 0.2s;
    white-space: nowrap;
  }

  .tab.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 500; }
  .tab:hover:not(.active) { color: var(--text); }

  .btn-signout {
    background: none;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    padding: 6px 12px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.78rem;
    color: var(--muted);
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s;
    white-space: nowrap;
    margin-left: auto;
  }

  .btn-signout:hover { border-color: var(--danger); color: var(--danger); }

  .tab-panel { display: none; padding: 36px 16px 80px; }
  .tab-panel.active { display: block; }
  .container { max-width: 560px; margin: 0 auto; }

  /* ‚îÄ‚îÄ SHARED ‚îÄ‚îÄ */
  .panel-header { margin-bottom: 28px; }

  .panel-header h2 {
    font-family: 'DM Serif Display', serif;
    font-size: 2rem;
    font-weight: 400;
    letter-spacing: -0.5px;
  }

  .subtitle { color: var(--muted); font-size: 0.85rem; font-weight: 300; margin-top: 4px; }

  .sync-status {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.78rem;
    color: var(--muted);
    margin-top: 6px;
  }

  .sync-dot { width: 7px; height: 7px; border-radius: 50%; background: #ccc; transition: background 0.3s; }
  .sync-dot.connected { background: var(--accent); }
  .sync-dot.connecting { background: #f0a500; animation: pulse 1s infinite; }
  .sync-dot.error { background: var(--danger); }

  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  /* ‚îÄ‚îÄ SHOPPING ‚îÄ‚îÄ */
  .add-form { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 28px; }

  .add-form input[type="text"], .add-form select {
    padding: 12px 14px;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    background: var(--surface);
    outline: none;
    color: var(--text);
    transition: border-color 0.2s;
  }

  .add-form input[type="text"] { flex: 1; min-width: 120px; }
  .add-form input[type="text"]:focus, .add-form select:focus { border-color: var(--accent); }

  .btn-add {
    padding: 12px 18px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 10px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: opacity 0.2s;
    white-space: nowrap;
    flex: 1;
  }

  .btn-add:hover { opacity: 0.88; }

  @media (min-width: 480px) {
    .btn-add { flex: 0 0 auto; }
  }

  .category-block { margin-bottom: 22px; animation: fadeIn 0.25s ease; }

  @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }

  .category-label {
    font-size: 0.72rem; font-weight: 500; letter-spacing: 0.12em;
    text-transform: uppercase; color: var(--muted); margin-bottom: 8px; padding-left: 4px;
  }

  .items-list { background: var(--surface); border: 1.5px solid var(--border); border-radius: 12px; overflow: hidden; list-style: none; }

  .item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border); transition: background 0.15s; }
  .item:last-child { border-bottom: none; }
  .item:hover { background: #fdfcfa; }
  .item.checked .item-name { color: var(--checked-text); text-decoration: line-through; }

  .item-check { appearance: none; width: 20px; height: 20px; border: 1.5px solid var(--border); border-radius: 6px; cursor: pointer; flex-shrink: 0; transition: all 0.15s; position: relative; }
  .item-check:checked { background: var(--accent); border-color: var(--accent); }
  .item-check:checked::after { content:''; position:absolute; left:5px; top:2px; width:6px; height:10px; border:2px solid white; border-top:none; border-left:none; transform:rotate(45deg); }

  .item-name { flex: 1; font-size: 0.93rem; font-weight: 300; }
  .item-qty { font-size: 0.82rem; font-weight: 500; color: var(--accent); min-width: 36px; flex-shrink: 0; }
  .item.checked .item-qty { color: var(--checked-text); }
  .qty-field { width: 72px; flex-shrink: 0; }

  .btn-icon { background:none; border:none; cursor:pointer; color:var(--border); font-size:1rem; padding:2px 4px; border-radius:4px; transition:color 0.15s; flex-shrink:0; }
  .btn-icon:hover { color: var(--danger); }

  .checked-toggle { display:flex; align-items:center; gap:8px; margin-top:24px; padding:12px 16px; background:none; border:1.5px dashed var(--border); border-radius:10px; cursor:pointer; width:100%; font-family:'DM Sans',sans-serif; font-size:0.88rem; color:var(--muted); transition:border-color 0.2s,color 0.2s; }
  .checked-toggle:hover { border-color:var(--accent); color:var(--accent); }
  .checked-toggle .arrow { margin-left:auto; transition:transform 0.2s; font-size:0.75rem; }
  .checked-toggle.open .arrow { transform:rotate(180deg); }

  .checked-section { margin-top:12px; display:none; }
  .checked-section.visible { display:block; }

  .empty { text-align:center; padding:48px 20px; color:var(--muted); font-size:0.9rem; font-weight:300; }
  .empty span { display:block; font-size:2rem; margin-bottom:10px; }

  /* ‚îÄ‚îÄ RECIPES LIST ‚îÄ‚îÄ */
  .recipes-toolbar { display:flex; gap:8px; margin-bottom:24px; flex-wrap:wrap; align-items:center; }

  .recipes-toolbar select { padding:9px 12px; border:1.5px solid var(--border); border-radius:10px; font-family:'DM Sans',sans-serif; font-size:0.88rem; background:var(--surface); color:var(--text); outline:none; cursor:pointer; }

  .btn-new-recipe { margin-left:auto; padding:9px 18px; background:var(--accent); color:white; border:none; border-radius:10px; font-family:'DM Sans',sans-serif; font-size:0.88rem; font-weight:500; cursor:pointer; transition:opacity 0.2s; white-space:nowrap; }
  .btn-new-recipe:hover { opacity:0.88; }

  .recipe-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(230px,1fr)); gap:16px; }

  .recipe-card { background:var(--surface); border:1.5px solid var(--border); border-radius:14px; overflow:hidden; cursor:pointer; transition:box-shadow 0.2s,transform 0.15s; animation:fadeIn 0.25s ease; }
  .recipe-card:hover { box-shadow:0 4px 20px rgba(0,0,0,0.08); transform:translateY(-2px); }

  .recipe-card-photo { width:100%; height:140px; background:var(--bg); display:flex; align-items:center; justify-content:center; font-size:2.8rem; overflow:hidden; }
  .recipe-card-photo img { width:100%; height:100%; object-fit:cover; }

  .recipe-card-body { padding:14px 16px; }
  .recipe-card-category { font-size:0.7rem; font-weight:500; letter-spacing:0.1em; text-transform:uppercase; color:var(--accent); margin-bottom:4px; }
  .recipe-card-name { font-family:'DM Serif Display',serif; font-size:1.05rem; font-weight:400; line-height:1.3; margin-bottom:6px; }
  .recipe-card-meta { font-size:0.78rem; color:var(--muted); font-weight:300; }

  /* ‚îÄ‚îÄ RECIPE DETAIL / FORM ‚îÄ‚îÄ */
  #recipe-detail, #recipe-form { display:none; padding:36px 16px 80px; }
  #recipe-detail.active, #recipe-form.active { display:block; }

  .back-btn { display:inline-flex; align-items:center; gap:6px; background:none; border:none; font-family:'DM Sans',sans-serif; font-size:0.88rem; color:var(--muted); cursor:pointer; padding:0; margin-bottom:24px; transition:color 0.15s; }
  .back-btn:hover { color:var(--accent); }

  .recipe-detail-photo { width:100%; height:220px; border-radius:14px; background:var(--border); display:flex; align-items:center; justify-content:center; font-size:4rem; margin-bottom:24px; overflow:hidden; }
  .recipe-detail-photo img { width:100%; height:100%; object-fit:cover; }

  .recipe-detail-category { font-size:0.72rem; font-weight:500; letter-spacing:0.12em; text-transform:uppercase; color:var(--accent); margin-bottom:6px; }
  .recipe-detail-name { font-family:'DM Serif Display',serif; font-size:1.9rem; font-weight:400; letter-spacing:-0.3px; margin-bottom:6px; }
  .recipe-detail-source { font-size:0.82rem; color:var(--muted); margin-bottom:24px; }
  .recipe-detail-source a { color:var(--accent); text-decoration:none; }
  .recipe-detail-source a:hover { text-decoration:underline; }

  .btn-add-to-list { display:inline-flex; align-items:center; gap:8px; padding:11px 20px; background:var(--accent); color:white; border:none; border-radius:10px; font-family:'DM Sans',sans-serif; font-size:0.9rem; font-weight:500; cursor:pointer; margin-bottom:28px; transition:opacity 0.2s,background 0.2s,color 0.2s; }
  .btn-add-to-list:hover { opacity:0.88; }
  .btn-add-to-list.added { background:#e9f5ef; color:var(--accent); }

  .section-title { font-size:0.72rem; font-weight:500; letter-spacing:0.12em; text-transform:uppercase; color:var(--muted); margin-bottom:12px; margin-top:24px; }

  .ingredients-list { background:var(--surface); border:1.5px solid var(--border); border-radius:12px; overflow:hidden; list-style:none; }
  .ingredient-row { display:flex; gap:12px; padding:11px 16px; border-bottom:1px solid var(--border); font-size:0.92rem; align-items:center; }
  .ingredient-row:last-child { border-bottom:none; }
  .ingredient-qty { color:var(--muted); min-width:80px; font-weight:300; }
  .ingredient-row .ing-name { flex:1; }
  .btn-add-ing { background:none; border:1.5px solid var(--border); border-radius:7px; padding:3px 9px; font-family:'DM Sans',sans-serif; font-size:0.75rem; color:var(--muted); cursor:pointer; white-space:nowrap; transition:border-color 0.2s,color 0.2s,background 0.2s; flex-shrink:0; }
  .btn-add-ing:hover { border-color:var(--accent); color:var(--accent); }
  .btn-add-ing.added { background:#e9f5ef; border-color:#c8e8d8; color:var(--accent); }

  .method-text { background:var(--surface); border:1.5px solid var(--border); border-radius:12px; padding:16px; font-size:0.92rem; font-weight:300; line-height:1.7; }
  .method-text p, .notes-text p { margin-bottom: 0.6em; }
  .method-text p:last-child, .notes-text p:last-child { margin-bottom: 0; }
  .method-text ul, .method-text ol, .notes-text ul, .notes-text ol { padding-left: 1.4em; margin-bottom: 0.6em; }
  .method-text li, .notes-text li { margin-bottom: 0.2em; }
  .method-text strong, .notes-text strong { font-weight: 500; }
  .method-text em, .notes-text em { font-style: italic; }
  .method-text h2, .notes-text h2 { font-family: "DM Serif Display", serif; font-size: 1.05rem; font-weight: 400; margin: 0.8em 0 0.3em; }
  .method-text h3, .notes-text h3 { font-size: 0.88rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.06em; color: var(--muted); margin: 0.8em 0 0.3em; }
  .form-hint { font-size: 0.75rem; color: var(--muted); margin-top: 5px; font-weight: 300; }
  .notes-text { background:#fffdf7; border:1.5px solid #f0e8c8; border-radius:12px; padding:14px 16px; font-size:0.88rem; font-weight:300; line-height:1.6; color:#7a6a3a; }

  .detail-actions { display:flex; gap:10px; margin-top:28px; padding-top:20px; border-top:1px solid var(--border); }
  .btn-secondary { padding:10px 18px; background:none; border:1.5px solid var(--border); border-radius:10px; font-family:'DM Sans',sans-serif; font-size:0.88rem; color:var(--text); cursor:pointer; transition:border-color 0.2s,color 0.2s; }
  .btn-secondary:hover { border-color:var(--accent); color:var(--accent); }
  .btn-danger { padding:10px 18px; background:none; border:1.5px solid var(--border); border-radius:10px; font-family:'DM Sans',sans-serif; font-size:0.88rem; color:var(--muted); cursor:pointer; transition:border-color 0.2s,color 0.2s; margin-left:auto; }
  .btn-danger:hover { border-color:var(--danger); color:var(--danger); }

  /* ‚îÄ‚îÄ RECIPE FORM ‚îÄ‚îÄ */
  .form-field { margin-bottom:18px; }
  .form-field label { display:block; font-size:0.78rem; font-weight:500; letter-spacing:0.06em; text-transform:uppercase; color:var(--muted); margin-bottom:7px; }
  .form-field input[type="text"], .form-field input[type="url"], .form-field select, .form-field textarea { width:100%; padding:11px 14px; border:1.5px solid var(--border); border-radius:10px; font-family:'DM Sans',sans-serif; font-size:0.92rem; background:var(--surface); color:var(--text); outline:none; transition:border-color 0.2s; }
  .form-field input:focus, .form-field select:focus, .form-field textarea:focus { border-color:var(--accent); }
  .form-field textarea { resize:vertical; min-height:100px; line-height:1.6; }

  .ingredient-builder { display:flex; flex-direction:column; gap:8px; }
  .ingredient-row-input { display:flex; gap:8px; align-items:center; }
  .ingredient-row-input input { flex:1; padding:10px 12px; border:1.5px solid var(--border); border-radius:10px; font-family:'DM Sans',sans-serif; font-size:0.9rem; background:var(--surface); color:var(--text); outline:none; transition:border-color 0.2s; }
  .ingredient-row-input input:focus { border-color:var(--accent); }
  .ingredient-row-input input.qty-input { flex:0 0 110px; }
  .btn-remove-ingredient { background:none; border:none; color:var(--muted); cursor:pointer; font-size:1rem; padding:4px; border-radius:4px; transition:color 0.15s; flex-shrink:0; }
  .btn-remove-ingredient:hover { color:var(--danger); }
  .btn-add-ingredient { align-self:flex-start; padding:8px 14px; background:none; border:1.5px dashed var(--border); border-radius:8px; font-family:'DM Sans',sans-serif; font-size:0.83rem; color:var(--muted); cursor:pointer; transition:border-color 0.2s,color 0.2s; margin-top:4px; }
  .btn-add-ingredient:hover { border-color:var(--accent); color:var(--accent); }

  .photo-upload-area { border:1.5px dashed var(--border); border-radius:12px; padding:24px; text-align:center; cursor:pointer; transition:border-color 0.2s; position:relative; overflow:hidden; }
  .photo-upload-area:hover { border-color:var(--accent); }
  .photo-upload-area input[type="file"] { position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%; }
  .upload-preview { width:100%; height:160px; object-fit:cover; border-radius:8px; display:none; }
  .photo-upload-placeholder { color:var(--muted); font-size:0.88rem; }
  .photo-upload-placeholder span { display:block; font-size:2rem; margin-bottom:6px; }

  .form-actions { display:flex; gap:10px; margin-top:28px; }

  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.3); z-index:200; display:flex; align-items:center; justify-content:center; padding:20px; opacity:0; pointer-events:none; transition:opacity 0.2s; }
  .modal-overlay.open { opacity:1; pointer-events:all; }
  .modal { background:var(--surface); border-radius:16px; padding:28px 24px 24px; width:100%; max-width:400px; box-shadow:0 8px 40px rgba(0,0,0,0.12); transform:translateY(12px); transition:transform 0.2s; }
  .modal-overlay.open .modal { transform:translateY(0); }
  .modal h3 { font-family:'DM Serif Display',serif; font-size:1.3rem; font-weight:400; margin-bottom:18px; }
  .modal .form-field { margin-bottom:14px; }
  .modal .form-field label { display:block; font-size:0.75rem; font-weight:500; letter-spacing:0.06em; text-transform:uppercase; color:var(--muted); margin-bottom:6px; }
  .modal .form-field input, .modal .form-field select { width:100%; padding:11px 14px; border:1.5px solid var(--border); border-radius:10px; font-family:'DM Sans',sans-serif; font-size:0.92rem; background:var(--bg); color:var(--text); outline:none; transition:border-color 0.2s; }
  .modal .form-field input:focus, .modal .form-field select:focus { border-color:var(--accent); }
  .modal-actions { display:flex; gap:8px; margin-top:20px; }
  .modal-actions .btn-primary { flex:1; width:auto; margin-top:0; padding:11px; }
  .modal-actions .btn-secondary { padding:11px 18px; }

  /* ‚îÄ‚îÄ URL IMPORT MODAL ‚îÄ‚îÄ */
  .url-import-modal { background:var(--surface); border-radius:16px; padding:28px 24px 24px; width:100%; max-width:460px; box-shadow:0 8px 40px rgba(0,0,0,0.12); transform:translateY(12px); transition:transform 0.2s; }
  .modal-overlay.open .url-import-modal { transform:translateY(0); }
  .url-import-modal h3 { font-family:'DM Serif Display',serif; font-size:1.3rem; font-weight:400; margin-bottom:6px; }
  .url-import-modal .modal-subtitle { font-size:0.82rem; color:var(--muted); font-weight:300; margin-bottom:20px; }
  .url-import-modal .url-row { display:flex; gap:8px; }
  .url-import-modal .url-row input { flex:1; padding:11px 14px; border:1.5px solid var(--border); border-radius:10px; font-family:'DM Sans',sans-serif; font-size:0.92rem; background:var(--bg); color:var(--text); outline:none; transition:border-color 0.2s; }
  .url-import-modal .url-row input:focus { border-color:var(--accent); }
  .url-import-modal .url-row button { padding:11px 18px; background:var(--accent); color:white; border:none; border-radius:10px; font-family:'DM Sans',sans-serif; font-size:0.9rem; font-weight:500; cursor:pointer; white-space:nowrap; transition:opacity 0.2s; }
  .url-import-modal .url-row button:hover { opacity:0.88; }
  .url-import-modal .url-row button:disabled { opacity:0.5; cursor:not-allowed; }
  .import-status { margin-top:16px; padding:12px 14px; border-radius:10px; font-size:0.88rem; display:none; }
  .import-status.loading { background:#f0f8f4; color:var(--accent); border:1.5px solid #c8e8d8; display:block; }
  .import-status.error { background:#fdf0ee; color:var(--danger); border:1.5px solid #f5c0b8; display:block; }
  .import-status .spinner { display:inline-block; width:12px; height:12px; border:2px solid var(--accent); border-top-color:transparent; border-radius:50%; animation:spin 0.7s linear infinite; margin-right:8px; vertical-align:middle; }
  @keyframes spin { to { transform:rotate(360deg); } }
  .btn-import-manual { margin-top:14px; background:none; border:none; font-family:'DM Sans',sans-serif; font-size:0.83rem; color:var(--muted); cursor:pointer; text-decoration:underline; padding:0; }
  .btn-import-manual:hover { color:var(--accent); }


  /* ‚îÄ‚îÄ TAGS ‚îÄ‚îÄ */
  .tag-chip { display:inline-flex; align-items:center; gap:5px; padding:3px 10px; border-radius:20px; font-size:0.72rem; font-weight:500; letter-spacing:0.04em; cursor:default; white-space:nowrap; }
  .tag-chip.clickable { cursor:pointer; transition:opacity 0.15s; }
  .tag-chip.clickable:hover { opacity:0.75; }
  .recipe-tags { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:16px; }
  .recipe-card-tags { display:flex; flex-wrap:wrap; gap:4px; margin-top:6px; }
  .recipe-card-tags .tag-chip { font-size:0.65rem; padding:2px 8px; }

  /* Tag toggle in form */
  .tag-toggles { display:flex; flex-wrap:wrap; gap:8px; }
  .tag-toggle { display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:20px; border:1.5px solid var(--border); font-family:'DM Sans',sans-serif; font-size:0.82rem; font-weight:400; cursor:pointer; background:none; color:var(--muted); transition:all 0.15s; }
  .tag-toggle.selected { color:white; border-color:transparent; }
  .tag-toggle:hover:not(.selected) { border-color:var(--muted); color:var(--text); }

  /* Settings panel */
  .settings-section { margin-bottom:32px; }
  .settings-section h3 { font-family:'DM Serif Display',serif; font-size:1.3rem; font-weight:400; margin-bottom:6px; }
  .settings-section .section-desc { font-size:0.85rem; color:var(--muted); font-weight:300; margin-bottom:18px; }
  .tags-manager { display:flex; flex-direction:column; gap:10px; }
  .tag-manager-row { display:flex; align-items:center; gap:10px; background:var(--surface); border:1.5px solid var(--border); border-radius:10px; padding:10px 14px; }
  .tag-manager-row .tag-chip { pointer-events:none; }
  .tag-manager-row .tag-name { flex:1; font-size:0.92rem; font-weight:300; }
  .tag-color-swatch { width:16px; height:16px; border-radius:50%; flex-shrink:0; }
  .add-tag-form { display:flex; gap:8px; margin-top:4px; flex-wrap:wrap; }
  .add-tag-form input[type="text"] { flex:1; min-width:120px; padding:10px 14px; border:1.5px solid var(--border); border-radius:10px; font-family:'DM Sans',sans-serif; font-size:0.9rem; background:var(--surface); color:var(--text); outline:none; transition:border-color 0.2s; }
  .add-tag-form input[type="text"]:focus { border-color:var(--accent); }
  .color-picker-row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .color-btn { width:26px; height:26px; border-radius:50%; border:2px solid transparent; cursor:pointer; transition:transform 0.15s, border-color 0.15s; flex-shrink:0; }
  .color-btn:hover { transform:scale(1.15); }
  .color-btn.selected { border-color:var(--text); }

  .toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(20px); background:var(--text); color:white; padding:10px 20px; border-radius:10px; font-size:0.88rem; opacity:0; transition:opacity 0.3s,transform 0.3s; pointer-events:none; z-index:100; white-space:nowrap; }
  .toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

  .footer { text-align:center; padding:20px 16px 28px; }
  .footer-name { font-family:'DM Serif Display',serif; font-style:italic; font-size:1rem; color:var(--border); letter-spacing:0.02em; }

  .config-banner { background:#fff8e6; border:1.5px solid #f0d080; border-radius:10px; padding:14px 16px; margin-bottom:24px; font-size:0.88rem; line-height:1.6; color:#7a5c00; }
  .config-banner strong { display:block; margin-bottom:4px; }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-card">
    <h1>My <em>Shopping</em><br>List</h1>
    <p class="login-subtitle">Sign in to access your list</p>
    <div class="field">
      <label>Email</label>
      <input type="email" id="login-email" placeholder="you@example.com" autocomplete="email">
    </div>
    <div class="field">
      <label>Password</label>
      <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
    </div>
    <button class="btn-primary" id="login-btn" onclick="signIn()">Sign in</button>
    <div class="login-error" id="login-error"></div>
  </div>
</div>

<!-- APP -->
<div id="app-screen">
  <div class="tab-bar">

    <div class="tabs">
      <button class="tab active" id="tab-shopping" onclick="switchTab('shopping')">üõí Shopping</button>
      <button class="tab" id="tab-recipes" onclick="switchTab('recipes')">üç≥ Recipes</button>
      <button class="tab" id="tab-settings" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
    </div>
    <button class="btn-signout" onclick="signOut()">Sign out</button>
  </div>

  <!-- Shopping -->
  <div class="tab-panel active" id="panel-shopping">
    <div class="container">
      <div class="panel-header">
        <h2>Shopping List</h2>
        <p class="subtitle" id="stats-text">Loading‚Ä¶</p>
        <div class="sync-status">
          <div class="sync-dot connecting" id="sync-dot"></div>
          <span id="sync-label">Connecting‚Ä¶</span>
        </div>
      </div>
      <div class="config-banner" id="config-banner" style="display:none">
        <strong>‚ö†Ô∏è Firebase not configured yet</strong>
        Open this file in a text editor and replace the placeholder values in the firebaseConfig block.
      </div>
      <div class="add-form">
        <input type="text" id="item-input" placeholder="Add an item‚Ä¶" autocomplete="off">
        <select id="category-select" onchange="addItem()">
          <option value="Bakery">Bakery</option>
          <option value="Beverages">Beverages</option>
          <option value="Booze">Booze</option>
          <option value="Canned Food">Canned Food</option>
          <option value="Condiments">Condiments</option>
          <option value="Dairy">Dairy</option>
          <option value="Fresh Produce">Fresh Produce</option>
          <option value="Household &amp; Cleaning">Household &amp; Cleaning</option>
          <option value="Meat">Meat</option>
          <option value="Medication">Medication</option>
          <option value="Other">Other</option>
          <option value="Other Pantry Items">Other Pantry Items</option>
          <option value="Pets">Pets</option>
          <option value="Snacks">Snacks</option>
          <option value="Toiletries">Toiletries</option>
        </select>
      </div>
      <div id="active-list"></div>
      <button class="checked-toggle" id="checked-toggle" onclick="toggleChecked()" style="display:none">
        <span id="checked-label">üóÇ Checked off items</span>
        <span class="arrow">‚ñº</span>
      </button>
      <div class="checked-section" id="checked-section"></div>
    </div>
  </div>

  <!-- Recipes list -->
  <div class="tab-panel" id="panel-recipes">
    <div class="container">
      <div class="panel-header">
        <h2>Recipes</h2>
        <p class="subtitle" id="recipe-count-text">Your recipe collection</p>
      </div>
      <div class="recipes-toolbar">
        <select id="recipe-filter" onchange="renderRecipes()">
          <option value="">All categories</option>
          <option value="Breakfast">Breakfast</option>
          <option value="Lunch">Lunch</option>
          <option value="Dinner">Dinner</option>
          <option value="Baking">Baking</option>
          <option value="Soups">Soups</option>
          <option value="Salads">Salads</option>
          <option value="Desserts">Desserts</option>
          <option value="Snacks">Snacks</option>
          <option value="Condiments">Condiments</option>
          <option value="Drinks">Drinks</option>
        </select>
        <select id="tag-filter" onchange="renderRecipes()" style="display:none"><option value="">All tags</option></select>
        <button class="btn-new-recipe" onclick="openUrlImportModal()">+ New recipe</button>
      </div>
      <div class="recipe-grid" id="recipe-grid"></div>
    </div>
  </div>


  <!-- Settings -->
  <div class="tab-panel" id="panel-settings">
    <div class="container">
      <div class="panel-header">
        <h2>Settings</h2>
        <p class="subtitle">Manage your recipe tags</p>
      </div>
      <div class="settings-section">
        <h3>Recipe Tags</h3>
        <p class="section-desc">Create tags to organise and filter your recipes.</p>
        <div class="tags-manager" id="tags-manager"></div>
        <div class="add-tag-form" style="margin-top:16px">
          <input type="text" id="new-tag-input" placeholder="New tag name‚Ä¶" maxlength="20">
          <div class="color-picker-row" id="color-picker"></div>
          <button class="btn-add" style="padding:10px 16px;font-size:0.88rem" onclick="addTag()">Add tag</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Recipe detail -->
  <div id="recipe-detail">
    <div class="container">
      <button class="back-btn" onclick="closeRecipeDetail()">‚Üê Back to recipes</button>
      <div id="recipe-detail-content"></div>
    </div>
  </div>

  <!-- Recipe form -->
  <div id="recipe-form">
    <div class="container">
      <button class="back-btn" onclick="closeRecipeForm()">‚Üê Cancel</button>
      <div class="panel-header">
        <h2 id="form-title">New Recipe</h2>
      </div>
      <div class="form-field">
        <label>Recipe name *</label>
        <input type="text" id="rf-name" placeholder="e.g. Spaghetti Bolognese">
      </div>
      <div class="form-field">
        <label>Category</label>
        <select id="rf-category">
          <option value="Dinner">Dinner</option>
          <option value="Breakfast">Breakfast</option>
          <option value="Lunch">Lunch</option>
          <option value="Baking">Baking</option>
          <option value="Soups">Soups</option>
          <option value="Salads">Salads</option>
          <option value="Desserts">Desserts</option>
          <option value="Snacks">Snacks</option>
          <option value="Condiments">Condiments</option>
          <option value="Drinks">Drinks</option>
        </select>
      </div>
      <div class="form-field">
        <label>Source (website, book, etc.)</label>
        <input type="text" id="rf-source" placeholder="e.g. Ottolenghi Simple p.42 or https://...">
      </div>
      <div class="form-field">
        <label>Photo</label>
        <div class="photo-upload-area">
          <input type="file" id="rf-photo" accept="image/*" onchange="handlePhotoUpload(event)">
          <img class="upload-preview" id="photo-preview" alt="Preview">
          <div class="photo-upload-placeholder" id="photo-placeholder">
            <span>üì∑</span>Tap to upload a photo
          </div>
        </div>
      </div>
      <div class="form-field">
        <label>Ingredients</label>
        <div class="ingredient-builder" id="ingredient-builder"></div>
        <button class="btn-add-ingredient" onclick="addIngredientRow()">+ Add ingredient</button>
      </div>
      <div class="form-field">
        <label>Method</label>
        <textarea id="rf-method" placeholder="Write your method here‚Ä¶" rows="6"></textarea>
        <p class="form-hint">Supports markdown: **bold**, *italic*, - bullet, 1. numbered, ## Heading</p>
      </div>
      <div class="form-field">
        <label>Notes</label>
        <textarea id="rf-notes" placeholder="Tips, variations, serving suggestions‚Ä¶" rows="3"></textarea>
        <p class="form-hint">Supports markdown: **bold**, *italic*, - bullet</p>
      </div>
      <div class="form-field">
        <label>Tags</label>
        <div class="tag-toggles" id="rf-tags"></div>
      </div>
      <div class="form-actions">
        <button class="btn-primary" style="width:auto;padding:11px 28px" onclick="saveRecipe()">Save recipe</button>
        <button class="btn-secondary" onclick="closeRecipeForm()">Cancel</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="edit-modal" onclick="closeEditModal(event)">
  <div class="modal">
    <h3>Edit item</h3>
    <div class="form-field">
      <label>Quantity</label>
      <input type="text" id="edit-item-qty" placeholder="e.g. 2, 500g, 1 bunch">
    </div>
    <div class="form-field">
      <label>Item name</label>
      <input type="text" id="edit-item-name" placeholder="Item name">
    </div>
    <div class="form-field">
      <label>Category</label>
      <select id="edit-item-category">
        <option value="Bakery">Bakery</option>
        <option value="Beverages">Beverages</option>
        <option value="Condiments">Condiments</option>
        <option value="Dairy">Dairy</option>
        <option value="Fresh Produce">Fresh Produce</option>
        <option value="Household &amp; Cleaning">Household &amp; Cleaning</option>
        <option value="Meat">Meat</option>
        <option value="Medication">Medication</option>
        <option value="Pets">Pets</option>
        <option value="Booze">Booze</option>
        <option value="Canned Food">Canned Food</option>
        <option value="Other Pantry Items">Other Pantry Items</option>
        <option value="Snacks">Snacks</option>
        <option value="Toiletries">Toiletries</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn-primary" onclick="saveEditItem()">Save</button>
      <button class="btn-secondary" onclick="closeEditModal()">Cancel</button>
    </div>
  </div>
</div>
<div class="modal-overlay" id="url-import-modal" onclick="closeUrlImportModal(event)">
  <div class="url-import-modal">
    <h3>Add a recipe</h3>
    <p class="modal-subtitle">Paste a link from any recipe website to import it. If an error message appears, you'll need to import the recipe manually.</p>
    <div class="url-row">
      <input type="url" id="import-url-input" placeholder="https://www.example.com/recipe...">
      <button id="import-url-btn" onclick="importFromUrl()">Import</button>
    </div>
    <div class="import-status" id="import-status"></div>
    <button class="btn-import-manual" onclick="closeUrlImportModal(); openNewRecipeForm()">Or enter recipe manually ‚Üí</button>
  </div>
</div>
<div class="toast" id="toast"></div>
<footer class="footer"><span class="footer-name">shlist</span></footer>

<script src="config.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut as fbSignOut, onAuthStateChanged }
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getDatabase, ref, push, update, remove, onValue, off }
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
  const firebaseConfig = window.firebaseConfig || {};
  const isConfigured = !Object.values(firebaseConfig).some(v => String(v).startsWith('PASTE_'));
  if (!isConfigured) document.getElementById('config-banner').style.display = 'block';

  const app = isConfigured ? initializeApp(firebaseConfig) : null;
  const auth = isConfigured ? getAuth(app) : null;
  const db = isConfigured ? getDatabase(app) : null;

  let shoppingItems = [], recipes = [], userTags = [];
  let shoppingRef = null, recipesRef = null, tagsRef = null;
  const TAG_COLORS = ['#2d6a4f','#e07b39','#9b59b6','#2980b9','#c0392b','#16a085','#d4a017','#7f8c8d'];
  let selectedColor = TAG_COLORS[0];
  let editingRecipeId = null, photoBase64 = null;

  if (auth) {
    onAuthStateChanged(auth, user => {
      if (user) { showApp(); connectData(user.uid); }
      else { showLogin(); disconnectData(); }
    });
  }

  function showLogin() {
    document.getElementById('login-screen').style.display = 'flex';
    document.getElementById('app-screen').style.display = 'none';
  }

  function showApp() {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app-screen').style.display = 'flex';
  }

  function connectData(uid) {
    disconnectData();
    shoppingRef = ref(db, `users/${uid}/shoppingList`);
    setSyncStatus('connecting', 'Connecting‚Ä¶');
    onValue(shoppingRef, snap => {
      const d = snap.val();
      shoppingItems = d ? Object.entries(d).map(([id,v]) => ({id,...v})) : [];
      setSyncStatus('connected', 'Synced');
      renderShopping();
    }, () => setSyncStatus('error', 'Connection error'));

    recipesRef = ref(db, `users/${uid}/recipes`);
    onValue(recipesRef, snap => {
      const d = snap.val();
      recipes = d ? Object.entries(d).map(([id,v]) => ({id,...v})) : [];
      renderRecipes();
    });

    tagsRef = ref(db, `users/${uid}/tags`);
    onValue(tagsRef, snap => {
      const d = snap.val();
      if (d) {
        userTags = Object.entries(d).map(([id,v]) => ({id,...v}));
      } else {
        // Seed default tags on first use
        const defaults = [{name:'Winner',color:'#2d6a4f'},{name:'To try',color:'#e07b39'},{name:'Fail',color:'#c0392b'}];
        defaults.forEach(t => push(tagsRef, t));
        userTags = [];
      }
      renderTagsManager();
      renderTagFilter();
      renderTagToggles();
    });
  }

  function disconnectData() {
    if (shoppingRef) { off(shoppingRef); shoppingRef = null; }
    if (recipesRef) { off(recipesRef); recipesRef = null; }
    if (tagsRef) { off(tagsRef); tagsRef = null; }
    shoppingItems = []; recipes = []; userTags = [];
  }

  window.signIn = async function() {
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;
    const btn = document.getElementById('login-btn');
    const errEl = document.getElementById('login-error');
    errEl.style.display = 'none';
    btn.disabled = true; btn.textContent = 'Signing in‚Ä¶';
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch(e) {
      errEl.textContent = friendlyAuthError(e.code);
      errEl.style.display = 'block';
      btn.disabled = false; btn.textContent = 'Sign in';
    }
  };

  window.signOut = async function() { await fbSignOut(auth); };

  function friendlyAuthError(code) {
    if (['auth/invalid-credential','auth/wrong-password','auth/user-not-found'].includes(code))
      return 'Incorrect email or password. Please try again.';
    if (code === 'auth/invalid-email') return 'Please enter a valid email address.';
    if (code === 'auth/too-many-requests') return 'Too many attempts. Please try again later.';
    return 'Something went wrong. Please try again.';
  }

  // ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ
  window.switchTab = function(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.getElementById('tab-' + tab).classList.add('active');
    document.getElementById('panel-' + tab).classList.add('active');
    document.getElementById('recipe-detail').classList.remove('active');
    document.getElementById('recipe-form').classList.remove('active');
  };

  // ‚îÄ‚îÄ Shopping ‚îÄ‚îÄ
  window.addItem = function() {
    if (!shoppingRef) return;
    const input = document.getElementById('item-input');
    const qtyInput = document.getElementById('qty-input');
    const sel = document.getElementById('category-select');
    const cat = sel.value;
    const name = input.value.trim();
    const qty = qtyInput ? qtyInput.value.trim() : '';
    if (!name) return;
    push(shoppingRef, { name, qty: qty || '', category: cat, checked: false });
    input.value = '';
    if (qtyInput) qtyInput.value = '';
    sel.selectedIndex = 0;
    input.focus();
  };

  window.toggleCheck = function(id) {
    const item = shoppingItems.find(i => i.id === id);
    if (item && db && auth.currentUser)
      update(ref(db, `users/${auth.currentUser.uid}/shoppingList/${id}`), { checked: !item.checked });
  };

  window.deleteItem = function(id) {
    if (db && auth.currentUser)
      remove(ref(db, `users/${auth.currentUser.uid}/shoppingList/${id}`));
  };

  window.toggleChecked = function() {
    document.getElementById('checked-section').classList.toggle('visible');
    document.getElementById('checked-toggle').classList.toggle('open');
  };

  function setSyncStatus(state, label) {
    const dot = document.getElementById('sync-dot');
    const lbl = document.getElementById('sync-label');
    if (dot) dot.className = 'sync-dot ' + state;
    if (lbl) lbl.textContent = label;
  }

  function renderShopping() {
    const active = shoppingItems.filter(i => !i.checked);
    const checked = shoppingItems.filter(i => i.checked);
    const statsEl = document.getElementById('stats-text');
    if (statsEl) statsEl.textContent = shoppingItems.length === 0
      ? 'Nothing here yet ‚Äî add your first item'
      : `${active.length} item${active.length !== 1 ? 's' : ''} remaining${checked.length ? ` ¬∑ ${checked.length} checked off` : ''}`;

    const activeEl = document.getElementById('active-list');
    if (!activeEl) return;

    if (active.length === 0) {
      activeEl.innerHTML = checked.length === 0
        ? `<div class="empty"><span>üõí</span>Your list is empty</div>`
        : `<div class="empty"><span>‚úÖ</span>All done!</div>`;
    } else {
      const cats = [...new Set(active.map(i => i.category))];
      activeEl.innerHTML = cats.map(cat => {
        const catItems = active.filter(i => i.category === cat);
        return `<div class="category-block">
          ${cats.length > 1 || cat !== 'General' ? `<div class="category-label">${cat}</div>` : ''}
          <ul class="items-list">
            ${catItems.map(item => `
              <li class="item">
                <input type="checkbox" class="item-check" onchange="toggleCheck('${item.id}')">
                ${item.qty ? `<span class="item-qty">${escHtml(item.qty)}</span>` : ''}
                <span class="item-name">${escHtml(item.name)}</span>
                <button class="btn-icon" onclick="openEditItem('${item.id}')" title="Edit" style="color:var(--muted);font-size:0.85rem">‚úé</button>
                <button class="btn-icon" onclick="deleteItem('${item.id}')" title="Remove">‚úï</button>
              </li>`).join('')}
          </ul></div>`;
      }).join('');
    }

    const toggleBtn = document.getElementById('checked-toggle');
    const checkedEl = document.getElementById('checked-section');
    if (checked.length === 0) {
      toggleBtn.style.display = 'none'; checkedEl.innerHTML = '';
    } else {
      toggleBtn.style.display = 'flex';
      document.getElementById('checked-label').textContent = `üóÇ Checked off items (${checked.length})`;
      const checkedCats = [...new Set(checked.map(i => i.category))];
      checkedEl.innerHTML = checkedCats.map(cat => {
        const catItems = checked.filter(i => i.category === cat);
        return `<div class="category-block">
          ${checkedCats.length > 1 || cat !== 'General' ? `<div class="category-label">${cat}</div>` : ''}
          <ul class="items-list">
            ${catItems.map(item => `
              <li class="item checked">
                <input type="checkbox" class="item-check" checked onchange="toggleCheck('${item.id}')">
                ${item.qty ? `<span class="item-qty">${escHtml(item.qty)}</span>` : ''}
                <span class="item-name">${escHtml(item.name)}</span>
                <button class="btn-icon" onclick="openEditItem('${item.id}')" title="Edit" style="color:var(--muted);font-size:0.85rem">‚úé</button>
                <button class="btn-icon" onclick="deleteItem('${item.id}')" title="Remove">‚úï</button>
              </li>`).join('')}
          </ul></div>`;
      }).join('');
    }
  }


  // ‚îÄ‚îÄ Tags ‚îÄ‚îÄ
  function tagChipHtml(tag, clickable) {
    return `<span class="tag-chip${clickable ? ' clickable' : ''}" style="background:${tag.color}20;color:${tag.color};border:1.5px solid ${tag.color}40">${escHtml(tag.name)}</span>`;
  }

  function renderTagsManager() {
    const mgr = document.getElementById('tags-manager');
    if (!mgr) return;
    if (userTags.length === 0) {
      mgr.innerHTML = '<p style="color:var(--muted);font-size:0.88rem;font-weight:300">No tags yet ‚Äî add one below!</p>';
    } else {
      mgr.innerHTML = userTags.map(tag => `
        <div class="tag-manager-row">
          ${tagChipHtml(tag, false)}
          <span class="tag-name">${escHtml(tag.name)}</span>
          <button class="btn-icon" onclick="deleteTag('${tag.id}')" title="Delete">‚úï</button>
        </div>`).join('');
    }
    renderColorPicker();
  }

  function renderColorPicker() {
    const picker = document.getElementById('color-picker');
    if (!picker) return;
    picker.innerHTML = TAG_COLORS.map(c =>
      `<button class="color-btn${c === selectedColor ? ' selected' : ''}" style="background:${c}" onclick="selectColor('${c}')" title="${c}"></button>`
    ).join('');
  }

  function renderTagFilter() {
    const sel = document.getElementById('tag-filter');
    if (!sel) return;
    const current = sel.value;
    sel.innerHTML = '<option value="">All tags</option>' +
      userTags.map(t => `<option value="${escHtml(t.id)}"${t.id === current ? ' selected' : ''}>${escHtml(t.name)}</option>`).join('');
    sel.style.display = userTags.length > 0 ? '' : 'none';
  }

  function renderTagToggles() {
    const container = document.getElementById('rf-tags');
    if (!container) return;
    const selectedIds = Array.from(container.querySelectorAll('.tag-toggle.selected')).map(b => b.dataset.id);
    if (userTags.length === 0) {
      container.innerHTML = '<p style="color:var(--muted);font-size:0.82rem;font-weight:300">No tags yet ‚Äî create some in Settings</p>';
      return;
    }
    container.innerHTML = userTags.map(tag => `
      <button class="tag-toggle${selectedIds.includes(tag.id) ? ' selected' : ''}"
        data-id="${tag.id}"
        style="${selectedIds.includes(tag.id) ? `background:${tag.color};` : ''}"
        onclick="toggleTagOnRecipe('${tag.id}', '${tag.color}', this)">
        ${escHtml(tag.name)}
      </button>`).join('');
  }

  window.toggleTagOnRecipe = function(id, color, btn) {
    btn.classList.toggle('selected');
    if (btn.classList.contains('selected')) btn.style.background = color;
    else btn.style.background = '';
  };

  window.selectColor = function(color) {
    selectedColor = color;
    renderColorPicker();
  };

  window.addTag = function() {
    const input = document.getElementById('new-tag-input');
    const name = input.value.trim();
    if (!name || !tagsRef) return;
    if (userTags.some(t => t.name.toLowerCase() === name.toLowerCase())) {
      showToast('Tag already exists!'); return;
    }
    push(tagsRef, { name, color: selectedColor });
    input.value = '';
  };

  window.deleteTag = function(id) {
    if (!tagsRef) return;
    if (!confirm('Delete this tag? It will be removed from all recipes.')) return;
    if (auth.currentUser) remove(ref(db, `users/${auth.currentUser.uid}/tags/${id}`));
    // Remove tag from all recipes
    if (auth.currentUser) {
      const uid = auth.currentUser.uid;
      recipes.forEach(r => {
        if (r.tags && r.tags[id]) {
          remove(ref(db, `users/${uid}/recipes/${r.id}/tags/${id}`));
        }
      });
    }
  };

  // ‚îÄ‚îÄ Recipes ‚îÄ‚îÄ
  window.renderRecipes = function() {
    const filter = document.getElementById('recipe-filter')?.value || '';
    const tagFilter = document.getElementById('tag-filter')?.value || '';
    let filtered = filter ? recipes.filter(r => r.category === filter) : [...recipes];
    if (tagFilter) filtered = filtered.filter(r => r.tags && r.tags[tagFilter]);
    const countEl = document.getElementById('recipe-count-text');
    if (countEl) countEl.textContent = recipes.length === 0
      ? 'No recipes yet ‚Äî add your first one!'
      : `${filtered.length} recipe${filtered.length !== 1 ? 's' : ''}${filter ? ` in ${filter}` : ''}`;

    const grid = document.getElementById('recipe-grid');
    if (!grid) return;

    if (filtered.length === 0) {
      grid.innerHTML = `<div class="empty" style="grid-column:1/-1"><span>üç≥</span>${filter ? 'No recipes in this category' : 'No recipes yet'}</div>`;
      return;
    }

    grid.innerHTML = filtered.map(r => `
      <div class="recipe-card" onclick="openRecipeDetail('${r.id}')">
        <div class="recipe-card-photo">
          ${r.photo ? `<img src="${r.photo}" alt="${escHtml(r.name)}">` : categoryEmoji(r.category)}
        </div>
        <div class="recipe-card-body">
          <div class="recipe-card-category">${escHtml(r.category || '')}</div>
          <div class="recipe-card-name">${escHtml(r.name)}</div>
          <div class="recipe-card-meta">${r.ingredients && r.ingredients.length ? r.ingredients.length + ' ingredient' + (r.ingredients.length !== 1 ? 's' : '') : 'No ingredients'}</div>
          ${r.tags && Object.keys(r.tags).length ? `<div class="recipe-card-tags">${userTags.filter(t => r.tags && r.tags[t.id]).map(t => tagChipHtml(t, false)).join('')}</div>` : ''}
        </div>
      </div>`).join('');
  };

  window.openRecipeDetail = function(id) {
    const r = recipes.find(r => r.id === id);
    if (!r) return;
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.getElementById('recipe-form').classList.remove('active');
    document.getElementById('recipe-detail').classList.add('active');

    const sourceHtml = r.source
      ? `<div class="recipe-detail-source">Source: ${r.source.startsWith('http')
          ? `<a href="${escHtml(r.source)}" target="_blank">${escHtml(r.source)}</a>`
          : escHtml(r.source)}</div>`
      : '';

    const ingredientsHtml = r.ingredients && r.ingredients.length
      ? `<div class="section-title">Ingredients</div>
         <ul class="ingredients-list">
           ${r.ingredients.map((ing, idx) => `
             <li class="ingredient-row">
               <span class="ingredient-qty">${escHtml(ing.qty || '')}</span>
               <span class="ing-name">${escHtml(ing.name)}</span>
               <button class="btn-add-ing" id="ing-btn-${id}-${idx}" onclick="addSingleIngredient('${id}', ${idx}, this)">+ List</button>
             </li>`).join('')}
         </ul>`
      : '';

    const methodHtml = r.method ? `<div class="section-title">Method</div><div class="method-text">${renderMarkdown(r.method)}</div>` : '';
    const notesHtml = r.notes ? `<div class="section-title">Notes</div><div class="notes-text">${renderMarkdown(r.notes)}</div>` : '';

    document.getElementById('recipe-detail-content').innerHTML = `
      <div class="recipe-detail-photo">
        ${r.photo ? `<img src="${r.photo}" alt="${escHtml(r.name)}">` : categoryEmoji(r.category)}
      </div>
      <div class="recipe-detail-category">${escHtml(r.category || '')}</div>
      <div class="recipe-detail-name">${escHtml(r.name)}</div>
      ${r.tags && Object.keys(r.tags).length ? `<div class="recipe-tags">${userTags.filter(t => r.tags && r.tags[t.id]).map(t => tagChipHtml(t, false)).join('')}</div>` : ''}
      ${sourceHtml}
      ${r.ingredients && r.ingredients.length
        ? `<button class="btn-add-to-list" id="add-to-list-btn" onclick="addRecipeToList('${id}')">üõí Add all ingredients to shopping list</button>`
        : ''}
      ${ingredientsHtml}${methodHtml}${notesHtml}
      <div class="detail-actions">
        <button class="btn-secondary" onclick="openEditRecipeForm('${id}')">Edit recipe</button>
        <button class="btn-danger" onclick="deleteRecipe('${id}')">Delete</button>
      </div>`;
  };

  window.closeRecipeDetail = function() {
    document.getElementById('recipe-detail').classList.remove('active');
    document.getElementById('panel-recipes').classList.add('active');
  };

  window.addRecipeToList = function(id) {
    const r = recipes.find(r => r.id === id);
    if (!r || !r.ingredients || !shoppingRef) return;
    r.ingredients.forEach(ing => {
      push(shoppingRef, { name: ing.name, qty: ing.qty || '', category: 'General', checked: false });
    });
    const btn = document.getElementById('add-to-list-btn');
    if (btn) { btn.textContent = '‚úÖ Added to list!'; btn.classList.add('added'); }
    showToast(`${r.ingredients.length} ingredient${r.ingredients.length !== 1 ? 's' : ''} added to your shopping list`);
  };

  window.addSingleIngredient = function(recipeId, idx, btn) {
    const r = recipes.find(r => r.id === recipeId);
    if (!r || !r.ingredients || !shoppingRef) return;
    const ing = r.ingredients[idx];
    if (!ing) return;
    push(shoppingRef, { name: ing.name, qty: ing.qty || '', category: 'General', checked: false });
    btn.textContent = '‚úì Added';
    btn.classList.add('added');
    btn.disabled = true;
  };

  window.deleteRecipe = function(id) {
    if (!confirm('Delete this recipe?')) return;
    if (db && auth.currentUser) {
      remove(ref(db, `users/${auth.currentUser.uid}/recipes/${id}`));
      closeRecipeDetail();
    }
  };

  // ‚îÄ‚îÄ Recipe form ‚îÄ‚îÄ
  window.openNewRecipeForm = function() {
    editingRecipeId = null; photoBase64 = null;
    document.getElementById('form-title').textContent = 'New Recipe';
    document.getElementById('rf-name').value = '';
    document.getElementById('rf-category').value = 'Dinner';
    document.getElementById('rf-source').value = '';
    document.getElementById('rf-method').value = '';
    document.getElementById('rf-notes').value = '';
    document.getElementById('photo-preview').style.display = 'none';
    document.getElementById('photo-placeholder').style.display = 'block';
    document.getElementById('ingredient-builder').innerHTML = '';
    addIngredientRow();
    renderTagToggles();
    showFormView();
  };

  window.openEditRecipeForm = function(id) {
    const r = recipes.find(r => r.id === id);
    if (!r) return;
    editingRecipeId = id; photoBase64 = r.photo || null;
    document.getElementById('form-title').textContent = 'Edit Recipe';
    document.getElementById('rf-name').value = r.name || '';
    document.getElementById('rf-category').value = r.category || 'Dinner';
    document.getElementById('rf-source').value = r.source || '';
    document.getElementById('rf-method').value = r.method || '';
    document.getElementById('rf-notes').value = r.notes || '';
    if (r.photo) {
      document.getElementById('photo-preview').src = r.photo;
      document.getElementById('photo-preview').style.display = 'block';
      document.getElementById('photo-placeholder').style.display = 'none';
    } else {
      document.getElementById('photo-preview').style.display = 'none';
      document.getElementById('photo-placeholder').style.display = 'block';
    }
    const builder = document.getElementById('ingredient-builder');
    builder.innerHTML = '';
    if (r.ingredients && r.ingredients.length) r.ingredients.forEach(ing => addIngredientRow(ing.qty, ing.name));
    else addIngredientRow();
    // Pre-select existing tags
    renderTagToggles();
    if (r.tags) {
      setTimeout(() => {
        document.querySelectorAll('#rf-tags .tag-toggle').forEach(btn => {
          if (r.tags[btn.dataset.id]) {
            btn.classList.add('selected');
            btn.style.background = userTags.find(t => t.id === btn.dataset.id)?.color || '';
          }
        });
      }, 50);
    }
    showFormView();
  };

  function showFormView() {
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.getElementById('recipe-detail').classList.remove('active');
    document.getElementById('recipe-form').classList.add('active');
  }

  window.closeRecipeForm = function() {
    document.getElementById('recipe-form').classList.remove('active');
    if (editingRecipeId) openRecipeDetail(editingRecipeId);
    else document.getElementById('panel-recipes').classList.add('active');
  };

  window.addIngredientRow = function(qty = '', name = '') {
    const builder = document.getElementById('ingredient-builder');
    const row = document.createElement('div');
    row.className = 'ingredient-row-input';
    row.innerHTML = `
      <input type="text" class="qty-input" placeholder="Qty (e.g. 2 cups)" value="${escHtml(qty)}">
      <input type="text" placeholder="Ingredient name" value="${escHtml(name)}">
      <button class="btn-remove-ingredient" onclick="this.parentElement.remove()" title="Remove">‚úï</button>`;
    builder.appendChild(row);
    if (!qty && !name) row.querySelector('input').focus();
  };

  window.handlePhotoUpload = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    // Resize large images before storing
    const reader = new FileReader();
    reader.onload = ev => {
      const img = new Image();
      img.onload = () => {
        const MAX = 800;
        let w = img.width, h = img.height;
        if (w > MAX || h > MAX) {
          if (w > h) { h = Math.round(h * MAX / w); w = MAX; }
          else { w = Math.round(w * MAX / h); h = MAX; }
        }
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        photoBase64 = canvas.toDataURL('image/jpeg', 0.8);
        document.getElementById('photo-preview').src = photoBase64;
        document.getElementById('photo-preview').style.display = 'block';
        document.getElementById('photo-placeholder').style.display = 'none';
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  };

  window.saveRecipe = function() {
    const name = document.getElementById('rf-name').value.trim();
    if (!name) { alert('Please enter a recipe name.'); return; }
    const rows = document.querySelectorAll('#ingredient-builder .ingredient-row-input');
    const ingredients = Array.from(rows).map(row => {
      const inputs = row.querySelectorAll('input');
      return { qty: inputs[0].value.trim(), name: inputs[1].value.trim() };
    }).filter(ing => ing.name);

    const selectedTagBtns = document.querySelectorAll('#rf-tags .tag-toggle.selected');
    const tags = {};
    selectedTagBtns.forEach(btn => { tags[btn.dataset.id] = true; });

    const recipeData = {
      name,
      category: document.getElementById('rf-category').value,
      source: document.getElementById('rf-source').value.trim(),
      method: document.getElementById('rf-method').value.trim(),
      notes: document.getElementById('rf-notes').value.trim(),
      ingredients,
      tags,
      photo: photoBase64 || null,
      updatedAt: Date.now()
    };

    if (!db || !auth.currentUser) return;
    const uid = auth.currentUser.uid;

    if (editingRecipeId) {
      update(ref(db, `users/${uid}/recipes/${editingRecipeId}`), recipeData);
      showToast('Recipe updated!');
      const savedId = editingRecipeId;
      document.getElementById('recipe-form').classList.remove('active');
      setTimeout(() => openRecipeDetail(savedId), 150);
    } else {
      push(ref(db, `users/${uid}/recipes`), { ...recipeData, createdAt: Date.now() });
      showToast('Recipe saved!');
      document.getElementById('recipe-form').classList.remove('active');
      document.getElementById('panel-recipes').classList.add('active');
    }
  };

  function categoryEmoji(cat) {
    const map = { Breakfast:'ü•û', Lunch:'ü•ó', Dinner:'üçΩÔ∏è', Baking:'üßÅ', Soups:'üç≤', Salads:'ü•ô', Desserts:'üç∞', Snacks:'üçø', Drinks:'ü•§', Condiments:'ü´ô' };
    return map[cat] || 'üç≥';
  }

  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2800);
  }

  function escHtml(str) {
    return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function renderMarkdown(str) {
    if (!str) return '';
    const lines = escHtml(str).split('\n');
    const out = [];
    let i = 0;
    while (i < lines.length) {
      const line = lines[i];
      if (line.startsWith('### ')) {
        out.push('<h3>' + fmt(line.slice(4)) + '</h3>'); i++;
      } else if (line.startsWith('## ')) {
        out.push('<h2>' + fmt(line.slice(3)) + '</h2>'); i++;
      } else if (line.startsWith('- ')) {
        const items = [];
        while (i < lines.length && lines[i].startsWith('- ')) {
          items.push('<li>' + fmt(lines[i].slice(2)) + '</li>'); i++;
        }
        out.push('<ul>' + items.join('') + '</ul>');
      } else if (line.match(/^[0-9]+[.] /)) {
        const items = [];
        while (i < lines.length && lines[i].match(/^[0-9]+[.] /)) {
          items.push('<li>' + fmt(lines[i].replace(/^[0-9]+[.] /, '')) + '</li>'); i++;
        }
        out.push('<ol>' + items.join('') + '</ol>');
      } else if (line.trim() === '') {
        out.push('<br>'); i++;
      } else {
        out.push('<p>' + fmt(line) + '</p>'); i++;
      }
    }
    return out.join('');
  }

  function fmt(s) {
    s = s.replace(/[*][*](.+?)[*][*]/g, '<strong>$1</strong>');
    s = s.replace(/[*](.+?)[*]/g, '<em>$1</em>');
    return s;
  }


  // ‚îÄ‚îÄ URL Import ‚îÄ‚îÄ
  window.openUrlImportModal = function() {
    document.getElementById('import-url-input').value = '';
    document.getElementById('import-status').className = 'import-status';
    document.getElementById('import-status').innerHTML = '';
    document.getElementById('import-url-btn').disabled = false;
    document.getElementById('import-url-btn').textContent = 'Import';
    document.getElementById('url-import-modal').classList.add('open');
    setTimeout(() => document.getElementById('import-url-input').focus(), 50);
  };

  window.closeUrlImportModal = function(e) {
    if (e && e.target !== document.getElementById('url-import-modal')) return;
    document.getElementById('url-import-modal').classList.remove('open');
  };

  const WORKER_URL = 'https://shlist.marijepierson.workers.dev';

  window.importFromUrl = async function() {
    const url = document.getElementById('import-url-input').value.trim();
    if (!url) return;

    const btn = document.getElementById('import-url-btn');
    const status = document.getElementById('import-status');

    btn.disabled = true;
    btn.textContent = 'Importing‚Ä¶';
    status.className = 'import-status loading';
    status.innerHTML = '<span class="spinner"></span> Claude is reading the recipe‚Ä¶';

    try {
      const res = await fetch(WORKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url })
      });

      const recipe = await res.json();

      if (!res.ok || recipe.error) {
        throw new Error(recipe.error || 'Something went wrong.');
      }

      if (!recipe.name) throw new Error('No recipe found on this page.');

      // Close modal and populate form
      document.getElementById('url-import-modal').classList.remove('open');

      editingRecipeId = null; photoBase64 = null;
      document.getElementById('form-title').textContent = 'New Recipe';
      document.getElementById('rf-name').value = recipe.name || '';
      document.getElementById('rf-category').value = recipe.category || 'Dinner';
      document.getElementById('rf-source').value = url;
      document.getElementById('rf-method').value = recipe.method || '';
      document.getElementById('rf-notes').value = recipe.notes || '';
      document.getElementById('photo-preview').style.display = 'none';
      document.getElementById('photo-placeholder').style.display = 'block';

      const builder = document.getElementById('ingredient-builder');
      builder.innerHTML = '';
      if (recipe.ingredients && recipe.ingredients.length) {
        recipe.ingredients.forEach(ing => addIngredientRow(ing.qty || '', ing.name || ''));
      } else {
        addIngredientRow();
      }

      showFormView();
      showToast('Recipe imported! Review and save when ready.');

    } catch(err) {
      status.className = 'import-status error';
      status.textContent = '‚ö† ' + (err.message || 'Something went wrong. Try entering the recipe manually.');
      btn.disabled = false;
      btn.textContent = 'Try again';
    }
  };

  let editingItemId = null;

  window.openEditItem = function(id) {
    const item = shoppingItems.find(i => i.id === id);
    if (!item) return;
    editingItemId = id;
    document.getElementById('edit-item-qty').value = item.qty || '';
    document.getElementById('edit-item-name').value = item.name;
    document.getElementById('edit-item-category').value = item.category || 'Other';
    document.getElementById('edit-modal').classList.add('open');
    setTimeout(() => document.getElementById('edit-item-name').select(), 50);
  };

  window.saveEditItem = function() {
    if (!editingItemId || !db || !auth.currentUser) return;
    const name = document.getElementById('edit-item-name').value.trim();
    const qty = document.getElementById('edit-item-qty').value.trim();
    const category = document.getElementById('edit-item-category').value;
    if (!name) return;
    update(ref(db, `users/${auth.currentUser.uid}/shoppingList/${editingItemId}`), { name, qty: qty || '', category });
    closeEditModal();
  };

  window.closeEditModal = function(e) {
    if (e && e.target !== document.getElementById('edit-modal')) return;
    document.getElementById('edit-modal').classList.remove('open');
    editingItemId = null;
  };

  document.getElementById('item-input')?.addEventListener('keydown', e => { if (e.key === 'Enter') window.addItem(); });
  document.getElementById('login-password')?.addEventListener('keydown', e => { if (e.key === 'Enter') window.signIn(); });
  document.getElementById('edit-item-name')?.addEventListener('keydown', e => { if (e.key === 'Enter') window.saveEditItem(); if (e.key === 'Escape') window.closeEditModal(); });
  document.getElementById('import-url-input')?.addEventListener('keydown', e => { if (e.key === 'Enter') window.importFromUrl(); if (e.key === 'Escape') window.closeUrlImportModal(); });
</script>
</body>
</html>